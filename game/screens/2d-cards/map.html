<style>

#map-container * {
	transition: none;
}

#map-container {
	position: absolute;
	left: 32px;
	right: 32px;
	top: 128px;
	bottom: 128px;
	overflow: hidden;
	background: rgba(0,25,50,0.2);
}

#map {
	position: absolute;
	left: 0;
	top: 0;
	width: 2048px;
	height: 2048px;	
}

#map-grid {
	opacity: 0.03;
	background: url('https://rolz.org/img/table/square.png');
	width: 2048px;
	height: 2048px;
	pointer-events: none;
}

#map-cursor {
	position: absolute;
	left: 0;
	top: 0;
	width: 256px;
	height: 256px;
	background-color: rgba(255,255,200,0.5);
	background-size: contain;
	pointer-events: none;
	opacity: 0.5;
	transition: transform 0.3s ease;
}

.dtile {
	position: absolute;
	left: 0;
	top: 0;
	width: 256px;
	height: 256px;
	background: rgba(0,0,20,.0);
	pointer-events: none;
	background-size: contain;
	transform:scale(1.15);
}

#map-mobs * {
	position: absolute;
}

.ship {
	width: 180px;
	height: 100px;
	background-image: url('img/ship-512px.png');
	background-size: contain;
}


</style>

<div id="map-container">
	<div id="map" 
		onmousemove="Map.on_mousemove(event)" 
		onmousedown="Map.on_mousedown(event)" 
		oncontextmenu="return(false);"
		onmouseup="Map.on_mouseup(event)">
		<div id="map-tiles"></div>
		<div id="map-grid"></div>
		<div id="map-mobs"></div>
		<div id="map-cursor"></div>
	</div>
</div>

<script>

function clamp(v, mn, mx) {
	if(v < mn) return(mn);
	if(v > mx) return(mx);
	return(v);
}

Map = {
	
	id_counter : 1000,
	my_ship : null,
	init : () => {
		Map.map_pane = $('#map');
		Map.cursor = $('#map-cursor');
		Map.place_tile('oooo', 3, 3);
		Map.my_ship = Map.place_mob('ship', 3, 3);
		//Map.change_cursor('oooo');
		var ofsx = (Map.map_pane.width()-$('#map-container').width())/2;
		var ofsy = (Map.map_pane.height()-$('#map-container').height())/2;
		Map.map_pane
			.css('left', -(ofsx)+'px')
			.css('top', -(ofsy)+'px')
	},
	
	map_pane : null,
	cursor : null,	
	cells : {},
	mobs : {},
	gridsize : 256,
	
	tile_types : {
		 
		oooo : {
			sides : ['o', 'o', 'o', 'o'],
			img : 'img/0000-512px.png',
		},
		xooo : {
			sides : ['x', 'o', 'o', 'o'],
			img : 'img/1000-512px.png',
		},
		xoxo : {
			sides : ['x', 'o', 'x', 'o'],
			img : 'img/1010-512px.png',
		},
		xxoo : {
			sides : ['x', 'x', 'o', 'o'],
			img : 'img/1100-512px.png',
		},
		xxxo : {
			sides : ['x', 'x', 'x', 'o'],
			img : 'img/1110-512px.png',
		},
		
	},
	
	mob_types : {
		
		ship : {
			name : 'Ship',
		},
		
	},
	
	current_tile_type : false,
	change_cursor : (type) => {
		Map.current_tile_type = type;
		Map.cursor_rotation = 0;
		if(type) Map.cursor
			.css('transform', 'rotate(0deg)')
			.css('background-image', 'url('+Map.tile_types[type].img+')');
	},
	cursor_rotation : 0,
	rotate_cursor : () => {
		Map.cursor_rotation += 90;
		//if(Map.cursor_rotation > 360) Map.cursor_rotation -= 360;
		Map.cursor
			.css('transform', 'rotate('+Map.cursor_rotation+'deg)');
	},
	
	place_mob : (type, x, y) => {
		var t = Map.cells[x+':'+y];
		if(!t) return;
		var mt = clone(Map.mob_types[type]);
		mt.id = 'mob_'+(Map.id_counter++);
		mt.type = type;
		mt.x = x;
		mt.y = y;
		Map.mobs[mt.id] = mt;
		var px = -90+(x+0.5)*Map.gridsize;
		var py = -40+(y+0.5)*Map.gridsize;
		$('#map-mobs').append('<div id="'+mt.id+'" class="mob '+type+'" '+
			'style="left:'+px+'px;top:'+py+'px;"></div>');
		return(mt);
	},
	
	place_tile : (type, x, y) => {
		var t = Map.tile_types[type];
		var px = x*Map.gridsize;
		var py = y*Map.gridsize;
		Map.cells[x+':'+y] = {
			type : type,
		};
		$('#map-tiles').append('<div id="t-'+x+'-'+y+'" class="dtile" '+
			'style="left:'+px+'px;top:'+py+'px;background-image:url('+t.img+');'+
			'transform:rotate('+(Map.cursor_rotation)+'deg) scale(1.15);"></div>');
		Map.change_cursor(false);
	},

	mouse : {
		down : false,
		x : 0, y : 0,
		gx : 0, gy : 0,
		ox : 0, oy : 0,
		drag_move : false,
		opos : { },
		button: false,
	},
	
	on_mousedown : (e) => {
		Map.mouse.button = e.button;
		Map.mouse.down = true;
		Map.mouse.ox = e.clientX;
		Map.mouse.oy = e.clientY;
		Map.mouse.drag_move = false;
		Map.mouse.opos = Map.map_pane.position();
	},

	on_mouseup : (e) => {
		Map.mouse.down = false;
		if(!Map.mouse.drag_move) {
			if(Map.mouse.button == 2) {
				Map.rotate_cursor();
			} else {
				Map.place_tile(Map.current_tile_type, Map.mouse.gx, Map.mouse.gy);
			}
		}
	},
	
	on_mousemove : (e) => {
		var x = Map.mouse.x = e.offsetX;
		var y = Map.mouse.y = e.offsetY;
		if(Map.mouse.down) {
			if(Math.abs(e.clientX - Map.mouse.ox) +
				Math.abs(e.client> - Map.mouse.oy) > 2) {
				Map.mouse.drag_move = true;
			}
			var dx = Map.mouse.opos.left + e.clientX - Map.mouse.ox;
			var dy = Map.mouse.opos.top + e.clientY - Map.mouse.oy;
			Map.map_pane
				.css('left', dx+'px')
				.css('top', dy+'px')
		} else {
			Map.mouse.gx = clamp(Math.floor(x/Map.gridsize), 0, 1024);
			Map.mouse.gy = clamp(Math.floor(y/Map.gridsize), 0, 1024);
			x = Map.mouse.gx*Map.gridsize;
			y = Map.mouse.gy*Map.gridsize;
			$('footer').text(Map.mouse.gx+':'+Map.mouse.gy);
			if(!Map.cursor) return;
			if(!Map.current_tile_type) 
				Map.cursor
					.css('display', 'none');
			else
				Map.cursor
					.css('display', 'inherit')
					.css('left', x+'px')
					.css('top', y+'px')
		}
	},
	
}

$(() => {
	
	Map.init();
	
});

</script>
